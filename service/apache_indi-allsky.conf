<VirtualHost *:80>
    RewriteEngine On
    RewriteCond "%{HTTPS}" off
    RewriteRule "^/(.*)" "https://%{SERVER_NAME}/$1" [R,L]
</VirtualHost>

<VirtualHost *:443>
    RewriteEngine On
    RewriteRule "^/$" "/indi-allsky/" [R]

    WSGIDaemonProcess indi-allsky user=%ALLSKY_USER% threads=3
    WSGIProcessGroup %{GLOBAL}
    WSGIScriptAlias /indi-allsky %ALLSKY_DIRECTORY%/indi_allsky/wsgi.py \
        application-group='%{GLOBAL}' process-group='%{GLOBAL}'
    WSGIScriptReloading On

    #ProxyPass /indi-allsky/static !
    #ProxyPass /indi-allsky/images !
    #ProxyPass /indi-allsky unix:/run/gunicorn-indi-allsky.sock|http://localhost/indi-allsky
    #ProxyPassReverse /indi-allsky http://localhost/indi-allsky

    <Directory %ALLSKY_DIRECTORY%>
        Require all granted
    </Directory>

    Alias /indi-allsky/static %ALLSKY_DIRECTORY%/indi_allsky/flask/static
    Alias /indi-allsky/images /var/www/html/allsky/images

    SSLEngine on
    SSLCertificateFile /etc/ssl/certs/ssl-cert-snakeoil.pem
    SSLCertificateKeyFile /etc/ssl/private/ssl-cert-snakeoil.key

    #Header always set Strict-Transport-Security "max-age=604800; includeSubDomains"  # 1 week
</VirtualHost>

WSGIPythonOptimize 1
WSGIPythonHome %ALLSKY_DIRECTORY%/virtualenv/indi-allsky
WSGIPythonPath %ALLSKY_DIRECTORY%/virtualenv/indi-allsky:%ALLSKY_DIRECTORY%
WSGIApplicationGroup %{GLOBAL}
