<VirtualHost *:80>
    RewriteEngine On

    ### Comment this section to permit HTTP access to indi-allsky
    RewriteCond "%{HTTPS}" off
    RewriteRule "^/(.*)" "https://%{SERVER_NAME}/$1" [R,L]
    ###

    RewriteRule "^/$" "/indi-allsky/" [R]

    ProxyPreserveHost On
    ProxyPass /indi-allsky/static !
    ProxyPass /indi-allsky/images !
    ProxyPass /indi-allsky unix:%DB_FOLDER%/%GUNICORN_SERVICE_NAME%.sock|http://localhost/indi-allsky
    ProxyPassReverse /indi-allsky unix:%DB_FOLDER%/%GUNICORN_SERVICE_NAME%.sock|http://localhost/indi-allsky

    <Directory %ALLSKY_DIRECTORY%>
        Require all granted
    </Directory>

    <Directory %IMAGE_FOLDER%>
        Require all granted
        Options +Indexes
    </Directory>

    <Location />
        AuthType Basic
        AuthName "Allsky"
        AuthUserFile "%ALLSKY_ETC%/apache.passwd"
        Require valid-user
        #SetEnv proxy-chain-auth On
    </Location>

    Alias /indi-allsky/images %IMAGE_FOLDER%
    Alias /indi-allsky/static %ALLSKY_DIRECTORY%/indi_allsky/flask/static
</VirtualHost>


<VirtualHost *:443>
    RewriteEngine On
    RewriteRule "^/$" "/indi-allsky/" [R]

    ProxyPreserveHost On
    ProxyPass /indi-allsky/static !
    ProxyPass /indi-allsky/images !
    ProxyPass /indi-allsky unix:%DB_FOLDER%/%GUNICORN_SERVICE_NAME%.sock|http://localhost/indi-allsky
    ProxyPassReverse /indi-allsky unix:%DB_FOLDER%/%GUNICORN_SERVICE_NAME%.sock|http://localhost/indi-allsky

    <Directory %ALLSKY_DIRECTORY%>
        Require all granted
    </Directory>

    <Directory %IMAGE_FOLDER%>
        Require all granted
        Options +Indexes
    </Directory>

    <Location />
        AuthType Basic
        AuthName "Allsky"
        AuthUserFile "%ALLSKY_ETC%/apache.passwd"
        Require valid-user
        #SetEnv proxy-chain-auth On
    </Location>

    Alias /indi-allsky/images %IMAGE_FOLDER%
    Alias /indi-allsky/static %ALLSKY_DIRECTORY%/indi_allsky/flask/static

    SSLEngine on
    SSLCertificateFile /etc/apache2/ssl/indi-allsky_apache.pem
    SSLCertificateKeyFile /etc/apache2/ssl/indi-allsky_apache.key

    #Header always set Strict-Transport-Security "max-age=604800; includeSubDomains"  # 1 week
</VirtualHost>
